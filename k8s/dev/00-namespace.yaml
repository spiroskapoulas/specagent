# =============================================================================
# SpecAgent Development Environment for k3s
# =============================================================================
# This creates a cloud-based development environment with:
# - code-server (VS Code in browser)
# - Claude Code CLI
# - All project dependencies pre-installed
# - Persistent storage for workspace
#
# Deploy with:
#   kubectl apply -f k8s/dev/
#
# Access:
#   kubectl port-forward -n specagent-dev svc/dev-environment 8443:8443
#   Open: https://localhost:8443
# =============================================================================

---
apiVersion: v1
kind: Namespace
metadata:
  name: specagent-dev
  labels:
    app.kubernetes.io/name: specagent-dev
    app.kubernetes.io/component: development

---
# =============================================================================
# PersistentVolumeClaim - Workspace storage
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: workspace-pvc
  namespace: specagent-dev
  labels:
    app.kubernetes.io/name: specagent-dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: local-path  # k3s default storage class

---
# =============================================================================
# PersistentVolumeClaim - Cache storage (pip, huggingface, npm)
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cache-pvc
  namespace: specagent-dev
  labels:
    app.kubernetes.io/name: specagent-dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-path

---
# =============================================================================
# Secret - API Keys (create separately or use sealed-secrets)
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: dev-secrets
  namespace: specagent-dev
  labels:
    app.kubernetes.io/name: specagent-dev
type: Opaque
stringData:
  # Replace with your actual key
  HF_API_KEY: "your-huggingface-api-key"
  # Password for code-server (change this!)
  CODE_SERVER_PASSWORD: "specagent-dev-2024"
  # Note: Claude Code with Pro subscription uses OAuth login (claude login)
  # No API key needed - run 'claude login' in terminal after deployment

---
# =============================================================================
# ConfigMap - Environment configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: dev-config
  namespace: specagent-dev
  labels:
    app.kubernetes.io/name: specagent-dev
data:
  # LLM Configuration
  USE_LOCAL_LLM: "false"
  LLM_MODEL: "Qwen/Qwen2.5-3B-Instruct"
  
  # Local GGUF Model settings (when USE_LOCAL_LLM=true)
  LLM_MODEL_PATH: "/models/qwen2.5-3b-instruct-q4_k_m.gguf"
  LLM_MODEL_NAME: "qwen2.5-3b-instruct"
  LLM_N_CTX: "4096"
  LLM_N_GPU_LAYERS: "0"
  LLM_TEMPERATURE: "0.1"
  LLM_MAX_TOKENS: "1024"
  
  # Embedding Configuration
  USE_LOCAL_EMBEDDINGS: "true"
  EMBEDDING_MODEL: "sentence-transformers/all-MiniLM-L6-v2"
  EMBEDDING_DIMENSION: "384"
  
  # Chunking
  CHUNK_SIZE: "512"
  CHUNK_OVERLAP: "64"
  
  # Development settings
  LOG_LEVEL: "DEBUG"
  ENABLE_TRACING: "true"
  PHOENIX_ENDPOINT: "http://localhost:6006"
  
  # Python settings
  PYTHONPATH: "/workspace/src"
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED: "1"
